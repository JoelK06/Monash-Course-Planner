<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monash Course Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const UNITS_CSV_URL = 'https://raw.githubusercontent.com/JoelK06/Monash-units/refs/heads/main/monash_units_complete.csv';
        
        const FACULTY_COLORS = {
            "Business & Economics": "#00bcd4",
            "Engineering": "#ff9800",
            "Science": "#4caf50",
            "Arts": "#e91e63",
            "Medicine": "#2196f3",
            "IT": "#9c27b0",
            "Law": "#795548",
            "Education": "#f06292",
            "Pharmacy": "#8bc34a",
            "Art, Design & Architecture": "#607d8b",
            "Unknown": "#0069a7"
        };
        
        // Icon components
        const Search = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );
        
        const Plus = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );
        
        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );
        
        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );
        
        const X = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );
        
        const Loader = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2" y1="12" x2="6" y2="12"></line>
                <line x1="18" y1="12" x2="22" y2="12"></line>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
            </svg>
        );
        
        const MonashCoursePlanner = () => {
            const [showLanding, setShowLanding] = useState(true);
            const [showSetup, setShowSetup] = useState(false);
            const [loading, setLoading] = useState(false);
            const [unitsData, setUnitsData] = useState([]);
            const [startYear, setStartYear] = useState(2025);
            const [degreeLength, setDegreeLength] = useState(4);
            const [semesters, setSemesters] = useState([]);
            const [selectedFaculty, setSelectedFaculty] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [draggedUnit, setDraggedUnit] = useState(null);
            const [hoveredUnit, setHoveredUnit] = useState(null);
            const [hoverTimeout, setHoverTimeout] = useState(null);
            const [contextMenuSemester, setContextMenuSemester] = useState(null);
            const [touchStartPos, setTouchStartPos] = useState(null);
            const [plans, setPlans] = useState([]);
            const [currentPlanId, setCurrentPlanId] = useState(null);
            const [selectedUnit, setSelectedUnit] = useState(null);
            const [selectedFromSidebar, setSelectedFromSidebar] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            
            useEffect(() => {
                const checkMobile = () => {
                    // Check if device is mobile based on touch support and screen size
                    const mobile = ('ontouchstart' in window || navigator.maxTouchPoints > 0) && window.innerWidth < 1024;
                    setIsMobile(mobile);
                };
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);
            
            useEffect(() => {
                const loadUnits = async () => {
                    const cached = localStorage.getItem('monashUnitsData');
                    const cacheTimestamp = localStorage.getItem('monashUnitsCacheTime');
                    const oneWeek = 7 * 24 * 60 * 60 * 1000;
                    
                    if (cached && cacheTimestamp && (Date.now() - parseInt(cacheTimestamp) < oneWeek)) {
                        setUnitsData(JSON.parse(cached));
                        return;
                    }
                    
                    setLoading(true);
                    try {
                        const response = await fetch(UNITS_CSV_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const text = await response.text();
                        
                        const lines = text.trim().split('\n');
                        
                        const units = lines.slice(1)
                            .filter(line => line.trim())
                            .map(line => {
                                const regex = /(?:,|^)("(?:[^"]|"")*"|[^,]*)/g;
                                const values = [];
                                let match;
                                while ((match = regex.exec(line)) !== null) {
                                    if (match[1]) {
                                        values.push(match[1].replace(/^"|"$/g, '').replace(/""/g, '"').trim());
                                    }
                                }
                                
                                return {
                                    code: values[0] || '',
                                    name: values[1] || '',
                                    level: values[2] || '',
                                    semesters: values[3] || '',
                                    faculty: values[4] || ''
                                };
                            })
                            .filter(unit => unit.code && unit.code !== 'code');
                        
                        setUnitsData(units);
                        localStorage.setItem('monashUnitsData', JSON.stringify(units));
                        localStorage.setItem('monashUnitsCacheTime', Date.now().toString());
                    } catch (error) {
                        console.error('Error loading units:', error);
                        alert('Failed to load units data: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadUnits();
            }, []);
            
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('monashCoursePlans');
                    if (saved) {
                        const allPlans = JSON.parse(saved);
                        setPlans(allPlans);
                        if (allPlans.length > 0) {
                            const lastPlanId = localStorage.getItem('monashLastPlanId');
                            const planToLoad = allPlans.find(p => p.id === lastPlanId) || allPlans[0];
                            setCurrentPlanId(planToLoad.id);
                            loadPlan(planToLoad);
                            setShowLanding(false);
                        }
                    }
                } catch (error) {
                    console.error('Error loading saved plans:', error);
                    localStorage.removeItem('monashCoursePlans');
                }
            }, []);
            
            const loadPlan = (plan) => {
                const validSemesters = plan.semesters.map(sem => ({
                    ...sem,
                    units: Array.isArray(sem.units) ? sem.units : [null, null, null, null]
                }));
                setStartYear(plan.startYear);
                setDegreeLength(plan.degreeLength);
                setSemesters(validSemesters);
            };
            
            const savePlans = (updatedPlans, planId) => {
                setPlans(updatedPlans);
                localStorage.setItem('monashCoursePlans', JSON.stringify(updatedPlans));
                localStorage.setItem('monashLastPlanId', planId);
            };
            
            const updateCurrentPlan = (newSemesters, newStartYear, newDegreeLength) => {
                const updatedPlans = plans.map(p => 
                    p.id === currentPlanId 
                        ? { ...p, semesters: newSemesters, startYear: newStartYear || startYear, degreeLength: newDegreeLength || degreeLength }
                        : p
                );
                savePlans(updatedPlans, currentPlanId);
            };
            
            useEffect(() => {
                if (semesters.length > 0 && currentPlanId) {
                    updateCurrentPlan(semesters);
                }
            }, [semesters]);
            
            const handleStartNew = () => {
                setShowLanding(false);
                setShowSetup(true);
            };
            
            const createNewPlan = () => {
                const newPlan = {
                    id: 'plan-' + Date.now(),
                    name: `Plan ${plans.length + 1}`,
                    startYear: 2025,
                    degreeLength: 4,
                    semesters: []
                };
                const newSemesters = [];
                for (let year = 0; year < 4; year++) {
                    newSemesters.push({
                        id: `s1-${year}`,
                        label: `Semester 1, ${2025 + year}`,
                        semesterType: 'Semester 1',
                        units: [null, null, null, null]
                    });
                    newSemesters.push({
                        id: `s2-${year}`,
                        label: `Semester 2, ${2025 + year}`,
                        semesterType: 'Semester 2',
                        units: [null, null, null, null]
                    });
                }
                newPlan.semesters = newSemesters;
                const updatedPlans = [...plans, newPlan];
                savePlans(updatedPlans, newPlan.id);
                setCurrentPlanId(newPlan.id);
                loadPlan(newPlan);
            };
            
            const switchPlan = (planId) => {
                const plan = plans.find(p => p.id === planId);
                if (plan) {
                    setCurrentPlanId(planId);
                    loadPlan(plan);
                    localStorage.setItem('monashLastPlanId', planId);
                }
            };
            
            const deletePlan = () => {
                if (plans.length === 1) {
                    // Last plan - clear everything
                    setPlans([]);
                    setSemesters([]);
                    setCurrentPlanId(null);
                    setShowLanding(true);
                    localStorage.removeItem('monashCoursePlans');
                    localStorage.removeItem('monashLastPlanId');
                } else {
                    const updatedPlans = plans.filter(p => p.id !== currentPlanId);
                    const newCurrentPlan = updatedPlans[0];
                    savePlans(updatedPlans, newCurrentPlan.id);
                    setCurrentPlanId(newCurrentPlan.id);
                    loadPlan(newCurrentPlan);
                }
            };
            
            const clearCurrentPlan = () => {
                if (confirm('Clear all units from this plan? This cannot be undone.')) {
                    const clearedSemesters = semesters.map(sem => ({
                        ...sem,
                        units: [null, null, null, null]
                    }));
                    setSemesters(clearedSemesters);
                }
            };
            
            const handleLoadCourse = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const data = JSON.parse(event.target.result);
                        setStartYear(data.startYear);
                        setDegreeLength(data.degreeLength);
                        setSemesters(data.semesters);
                        setShowLanding(false);
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            const handleImportCourse = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const data = JSON.parse(event.target.result);
                        const validSemesters = data.semesters.map(sem => ({
                            ...sem,
                            units: Array.isArray(sem.units) ? sem.units : [null, null, null, null]
                        }));
                        setSemesters(validSemesters);
                        setStartYear(data.startYear);
                        setDegreeLength(data.degreeLength);
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            const resetSemester = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units = [null, null, null, null];
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };
            
            const setAcademicLeave = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units = ['ACADEMIC_LEAVE'];
                newSemesters[semIndex].isAcademicLeave = true;
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };
            
            const removeAcademicLeave = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units = [null, null, null, null];
                newSemesters[semIndex].isAcademicLeave = false;
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };

            const addOverloadUnit = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units.push(null);
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };
            
            const removeOverloadUnit = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                if (newSemesters[semIndex].units.length > 4) {
                    newSemesters[semIndex].units.pop();
                    setSemesters(newSemesters);
                }
                setContextMenuSemester(null);
            };
            
            const deleteSemester = (semesterId) => {
                const semIndex = semesters.findIndex(s => s.id === semesterId);
                if (semIndex === semesters.length - 1 && semesters.length > 1) {
                    setSemesters(semesters.slice(0, -1));
                }
                setContextMenuSemester(null);
            };
                     
            const handleSetupComplete = () => {
                const newSemesters = [];
                for (let year = 0; year < degreeLength; year++) {
                    newSemesters.push({
                        id: `s1-${year}`,
                        label: `Semester 1, ${startYear + year}`,
                        semesterType: 'Semester 1',
                        units: [null, null, null, null]
                    });
                    newSemesters.push({
                        id: `s2-${year}`,
                        label: `Semester 2, ${startYear + year}`,
                        semesterType: 'Semester 2',
                        units: [null, null, null, null]
                    });
                }
                
                const newPlan = {
                    id: 'plan-' + Date.now(),
                    name: `Plan ${plans.length + 1}`,
                    startYear,
                    degreeLength,
                    semesters: newSemesters
                };
                
                const updatedPlans = [...plans, newPlan];
                savePlans(updatedPlans, newPlan.id);
                setCurrentPlanId(newPlan.id);
                setSemesters(newSemesters);
                setShowSetup(false);
            };
            
            const addSemester = () => {
                const lastSem = semesters[semesters.length - 1];
                const lastYear = parseInt(lastSem.label.split(', ')[1]);
                const isS1 = lastSem.semesterType === 'Semester 1';
                const newYear = isS1 ? lastYear : lastYear + 1;
                const newSemType = isS1 ? 'Semester 2' : 'Semester 1';
                
                setSemesters([...semesters, {
                    id: `${newSemType.toLowerCase().replace(' ', '')}-${Date.now()}`,
                    label: `${newSemType}, ${newYear}`,
                    semesterType: newSemType,
                    units: [null, null, null, null]
                }]);
            };
            
            const removeSemester = () => {
                if (semesters.length > 1) {
                    setSemesters(semesters.slice(0, -1));
                }
            };
            
            const handleDragStart = (unit) => {
                setDraggedUnit(unit);
                setSelectedUnit(null);
                setSelectedFromSidebar(false);
            };
            
            const handleUnitClick = (unit, isFromSidebar = false) => {
                if (selectedUnit && selectedUnit.code === unit.code) {
                    setSelectedUnit(null);
                    setSelectedFromSidebar(false);
                } else {
                    setSelectedUnit(unit);
                    setSelectedFromSidebar(isFromSidebar);
                }
            };
            
            const handleSlotClick = (semesterId, unitIndex) => {
                if (selectedUnit) {
                    handleDrop(semesterId, unitIndex);
                    setSelectedUnit(null);
                }
            };
            
            const handleTouchStart = (e, unit) => {
                const touch = e.touches[0];
                setTouchStartPos({ x: touch.clientX, y: touch.clientY });
                setDraggedUnit(unit);
            };
            
            const handleTouchMove = (e) => {
                if (!draggedUnit) return;
                e.preventDefault();
            };
            
            const handleTouchEnd = (e, semesterId, unitIndex) => {
                if (!draggedUnit) return;
                handleDrop(semesterId, unitIndex);
                setTouchStartPos(null);
            };
            
            const handleDrop = (semesterId, unitIndex) => {
                const unitToPlace = draggedUnit || selectedUnit;
                if (!unitToPlace) return;
                
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                
                // Check if we're moving from the grid (not from sidebar)
                let fromSemIndex = -1;
                let fromUnitIndex = -1;
                
                // Check if unit has an instance ID (meaning it's from the grid)
                const isFromGrid = unitToPlace._instanceId !== undefined;
                
                if (isFromGrid) {
                    // Look for source using unique instance ID
                    for (let i = 0; i < newSemesters.length; i++) {
                        const foundIndex = newSemesters[i].units.findIndex(u => 
                            u && u._instanceId === unitToPlace._instanceId
                        );
                        if (foundIndex !== -1) {
                            fromSemIndex = i;
                            fromUnitIndex = foundIndex;
                            break;
                        }
                    }
                    
                    // If moving to the same spot, do nothing
                    if (fromSemIndex === semIndex && fromUnitIndex === unitIndex) {
                        setDraggedUnit(null);
                        setSelectedUnit(null);
                        setSelectedFromSidebar(false);
                        return;
                    }
                    
                    // Moving from grid - swap positions
                    const temp = newSemesters[semIndex].units[unitIndex];
                    newSemesters[semIndex].units[unitIndex] = unitToPlace;
                    newSemesters[fromSemIndex].units[fromUnitIndex] = temp;
                } else {
                    // Adding from sidebar - check if duplicate exists in this semester
                    const duplicateIndex = newSemesters[semIndex].units.findIndex(
                        (u, idx) => u && u.code === unitToPlace.code && idx !== unitIndex
                    );
                    
                    if (duplicateIndex !== -1) {
                        // Replace the existing duplicate instead of creating another
                        newSemesters[semIndex].units[duplicateIndex] = null;
                    }
                    
                    // Create a new instance with unique ID
                    const newUnit = { ...unitToPlace, _instanceId: Date.now() + Math.random() };
                    newSemesters[semIndex].units[unitIndex] = newUnit;
                }
                
                setSemesters(newSemesters);
                setDraggedUnit(null);
                setSelectedUnit(null);
                setSelectedFromSidebar(false);
            };
            
            const removeUnit = (semesterId, unitIndex) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units[unitIndex] = null;
                setSemesters(newSemesters);
            };
            
            const exportPlan = () => {
                const currentPlan = plans.find(p => p.id === currentPlanId);
                const dataStr = JSON.stringify({ 
                    startYear, 
                    degreeLength, 
                    semesters,
                    name: currentPlan?.name || 'Course Plan'
                }, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `monash-${currentPlan?.name.toLowerCase().replace(/\s+/g, '-')}-${startYear}.json`;
                link.click();
            };
            
            const faculties = [...new Set(unitsData.map(u => u.faculty))].filter(Boolean).sort();
            const filteredUnits = searchQuery
                ? unitsData.filter(u =>
                    u.code.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    u.name.toLowerCase().includes(searchQuery.toLowerCase())
                  )
                : selectedFaculty
                ? unitsData.filter(u => u.faculty === selectedFaculty)
                : [];
            
            const hasDuplicateInSemester = (semester, unitCode) => {
                return semester.units.filter(u => u && u.code === unitCode).length > 1;
            };
            
            const isUnitOffered = (unit, semesterType) => {
                if (!unit) return true;
                if (!unit.semesters || unit.semesters.includes('Not offered')) return true;
                return unit.semesters.includes(semesterType);
            };
            
            const handleMouseEnter = (unit) => {
                const timeout = setTimeout(() => {
                    setHoveredUnit(unit);
                }, 800);
                setHoverTimeout(timeout);
            };
            
            const handleMouseLeave = () => {
                if (hoverTimeout) clearTimeout(hoverTimeout);
                const timeout = setTimeout(() => {
                    setHoveredUnit(null);
                }, 300);
                setHoverTimeout(timeout);
            };
            
            const handlePopupEnter = () => {
                if (hoverTimeout) clearTimeout(hoverTimeout);
            };
            
            const handlePopupLeave = () => {
                setHoveredUnit(null);
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="bg-white rounded-2xl shadow-2xl p-12 text-center">
                            <div className="mx-auto mb-4"><Loader /></div>
                            <h2 className="text-2xl font-bold text-gray-800">Loading Monash Units...</h2>
                            <p className="text-gray-600 mt-2">Fetching 5000+ units from database</p>
                        </div>
                    </div>
                );
            }
            
            if (showLanding) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-8">
                        <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl">
                            <h1 className="text-4xl font-bold text-gray-800 mb-6">Monash Course Planner</h1>
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-6 mb-8 rounded">
                                <h2 className="font-bold text-lg mb-3">Instructions:</h2>
                                <ul className="space-y-2 text-gray-700">
                                    <li>• Plan your entire Monash degree with drag-and-drop simplicity</li>
                                    <li>• Contains 5000+ units from the Monash handbook</li>
                                    <li>• Drag units from the sidebar into your semester grid</li>
                                    <li>• Click the menu button on semesters for more options</li>
                                    <li>• Create multiple plans and switch between them</li>
                                    <li>• Your plans auto-save in your browser</li>
                                    <li>• Always check the handbook before making final decisions</li>
                                </ul>
                            </div>
                            <div className="flex gap-4">
                                <button
                                    onClick={handleStartNew}
                                    className="flex-1 bg-blue-600 text-white py-4 px-6 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Start New Plan
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (showSetup) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-8">
                        <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-md">
                            <h2 className="text-3xl font-bold text-gray-800 mb-8">Setup Your Plan</h2>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Start Year
                                    </label>
                                    <input
                                        type="number"
                                        value={startYear}
                                        onChange={(e) => setStartYear(parseInt(e.target.value))}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Degree Length (years)
                                    </label>
                                    <input
                                        type="number"
                                        value={degreeLength}
                                        onChange={(e) => setDegreeLength(parseInt(e.target.value))}
                                        min="1"
                                        max="12"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <button
                                    onClick={handleSetupComplete}
                                    className="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Create Plan
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="flex h-screen bg-gray-50">
                    <div className="w-80 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                        <div className="p-4 border-b border-gray-200">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Unit Library</h2>
                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400"><Search /></div>
                                <input
                                    type="text"
                                    placeholder="Search units..."
                                    value={searchQuery}
                                    onChange={(e) => {
                                        setSearchQuery(e.target.value);
                                        setSelectedFaculty(null);
                                    }}
                                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4">
                            {!searchQuery && !selectedFaculty && (
                                <div className="space-y-2">
                                    {faculties.map(faculty => (
                                        <button
                                            key={faculty}
                                            onClick={() => setSelectedFaculty(faculty)}
                                            className="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg font-medium text-gray-700 transition"
                                        >
                                            {faculty}
                                        </button>
                                    ))}
                                </div>
                            )}
                            
                            {(searchQuery || selectedFaculty) && (
                                <div>
                                    {selectedFaculty && (
                                        <button
                                            onClick={() => setSelectedFaculty(null)}
                                            className="mb-4 text-sm text-blue-600 hover:text-blue-800"
                                        >
                                            ← Back to faculties
                                        </button>
                                    )}
                                    <div className="space-y-2">
                                        {filteredUnits.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8">
                                                No units found
                                            </div>
                                        ) : (
                                            filteredUnits.map(unit => (
                                                <div
                                                    key={unit.code}
                                                    draggable
                                                    onDragStart={() => handleDragStart(unit)}
                                                    onTouchStart={(e) => handleTouchStart(e, unit)}
                                                    onTouchMove={handleTouchMove}
                                                    onClick={() => handleUnitClick(unit, true)}
                                                    className={`bg-white border rounded-lg p-3 cursor-pointer hover:shadow-md transition flex touch-none ${
                                                        selectedUnit && selectedUnit.code === unit.code
                                                            ? 'border-blue-500 border-2 shadow-lg'
                                                            : 'border-gray-200'
                                                    }`}
                                                >
                                                    <div
                                                        className="w-1 rounded-l-lg mr-3"
                                                        style={{ backgroundColor: FACULTY_COLORS[unit.faculty] || FACULTY_COLORS["Unknown"] }}
                                                    />
                                                    <div className="flex-1">
                                                        <div className="font-bold text-gray-800">{unit.code}</div>
                                                        <div className="text-sm text-gray-600">{unit.name}</div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="flex-1 flex flex-col">
                        <div className="bg-white border-b border-gray-200 p-4 flex justify-between items-center flex-shrink-0">
                            <div className="flex items-center gap-2">
                                {plans.map(plan => (
                                    <button
                                        key={plan.id}
                                        onClick={() => switchPlan(plan.id)}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            plan.id === currentPlanId
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        {plan.name}
                                    </button>
                                ))}
                                <button
                                    onClick={createNewPlan}
                                    className="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition font-medium"
                                >
                                    + New Plan
                                </button>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={clearCurrentPlan}
                                    className="flex items-center gap-2 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"
                                >
                                    Clear Plan
                                </button>
                                <button
                                    onClick={deletePlan}
                                    className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
                                >
                                    Delete Plan
                                </button>
                                <button
                                    onClick={handleImportCourse}
                                    className="flex items-center gap-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"
                                >
                                    <Upload />
                                    Import
                                </button>
                                <button
                                    onClick={exportPlan}
                                    className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                                >
                                    <Download />
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-auto p-8">
                            <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                                <table className="w-full border-collapse" style={{ minWidth: '900px' }}>
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 p-3 text-left font-semibold" style={{width: '180px'}}>Semester</th>
                                                <th className="border border-gray-300 p-3 text-center font-semibold">Units</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {semesters.map((semester, semIdx) => (
                                                <tr key={semester.id}>
                                                    <td
                                                        className="border border-gray-300 p-3 font-medium bg-gray-50 relative align-top"
                                                        style={{width: '180px'}}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span>{semester.label}</span>
                                                            <button
                                                                onClick={() => setContextMenuSemester(contextMenuSemester === semester.id ? null : semester.id)}
                                                                className="text-gray-500 hover:text-gray-700 p-1"
                                                            >
                                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                                    <circle cx="12" cy="5" r="2"></circle>
                                                                    <circle cx="12" cy="12" r="2"></circle>
                                                                    <circle cx="12" cy="19" r="2"></circle>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        {contextMenuSemester === semester.id && (
                                                            <div className="absolute left-full ml-2 top-0 bg-white border border-gray-300 rounded-lg shadow-lg z-50 w-56">
                                                                <button
                                                                    onClick={() => resetSemester(semester.id)}
                                                                    className="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm"
                                                                >
                                                                    Reset Semester (4 units)
                                                                </button>
                                                                {!semester.isAcademicLeave && (
                                                                    <>
                                                                        <button
                                                                            onClick={() => addOverloadUnit(semester.id)}
                                                                            className="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm"
                                                                        >
                                                                            Add Overload Unit
                                                                        </button>
                                                                        {semester.units.length > 4 && (
                                                                            <button
                                                                                onClick={() => removeOverloadUnit(semester.id)}
                                                                                className="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm"
                                                                            >
                                                                                Remove Overload Unit
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={() => setAcademicLeave(semester.id)}
                                                                            className="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm border-t border-gray-200"
                                                                        >
                                                                            Set as Academic Leave
                                                                        </button>
                                                                    </>
                                                                )}
                                                                {semester.isAcademicLeave && (
                                                                    <button
                                                                        onClick={() => removeAcademicLeave(semester.id)}
                                                                        className="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm border-t border-gray-200"
                                                                    >
                                                                        Remove Academic Leave
                                                                    </button>
                                                                )}
                                                                {semIdx === semesters.length - 1 && (
                                                                    <button
                                                                        onClick={() => deleteSemester(semester.id)}
                                                                        className="w-full text-left px-4 py-2 hover:bg-red-100 text-sm text-red-600 border-t border-gray-200"
                                                                    >
                                                                        Delete Semester
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="border border-gray-300 p-2 align-top">
                                                        {semester.isAcademicLeave ? (
                                                            <div className="h-24 bg-yellow-50 border-2 border-yellow-300 rounded-lg flex items-center justify-center">
                                                                <span className="text-yellow-700 font-semibold">Academic Leave</span>
                                                            </div>
                                                        ) : (
                                                            <div className={isMobile ? 'grid gap-2 grid-cols-2' : 'grid gap-2 grid-cols-' + semester.units.length}>
                                                                {semester.units.map((unit, unitIdx) => (
                                                                <div
                                                                    key={unit?._instanceId || `empty-${unitIdx}`}
                                                                    className="flex"
                                                                    onDragOver={(e) => e.preventDefault()}
                                                                    onDrop={() => handleDrop(semester.id, unitIdx)}
                                                                    onTouchEnd={(e) => handleTouchEnd(e, semester.id, unitIdx)}
                                                                    onClick={() => handleSlotClick(semester.id, unitIdx)}
                                                                >
                                                                    {unit ? (
                                                                        <div
                                                                            className="relative bg-white border border-gray-200 rounded-lg p-3 h-24 flex group w-full overflow-hidden cursor-pointer"
                                                                            draggable
                                                                            onDragStart={() => handleDragStart(unit)}
                                                                            onTouchStart={(e) => handleTouchStart(e, unit)}
                                                                            onMouseEnter={() => handleMouseEnter(unit)}
                                                                            onMouseLeave={handleMouseLeave}
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleUnitClick(unit, false);
                                                                            }}
                                                                        >
                                                                            <div
                                                                                className="w-1 rounded-l-lg mr-3 flex-shrink-0"
                                                                                style={{ backgroundColor: FACULTY_COLORS[unit.faculty] || FACULTY_COLORS["Unknown"] }}
                                                                            />
                                                                            <div className="flex-1 min-w-0 overflow-hidden">
                                                                                <div className="font-bold text-gray-800 text-sm">{unit.code}</div>
                                                                                <div className="text-xs text-gray-600 line-clamp-2">{unit.name}</div>
                                                                                {!isUnitOffered(unit, semester.semesterType) && (
                                                                                    <div className="text-xs text-red-600 mt-1">
                                                                                        ⚠️ Not offered {semester.semesterType}
                                                                                    </div>
                                                                                )}
                                                                                {hasDuplicateInSemester(semester, unit.code) && (
                                                                                    <div className="text-xs text-orange-600 mt-1">
                                                                                        ⚠️ Duplicate in semester
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                            <button
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    removeUnit(semester.id, unitIdx);
                                                                                }}
                                                                                className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition flex-shrink-0"
                                                                            >
                                                                                <X />
                                                                            </button>
                                                                            
                                                                            {hoveredUnit && hoveredUnit.code === unit.code && (
                                                                                <div
                                                                                    className="absolute z-50 bg-gray-800 text-white p-2 rounded shadow-lg text-xs -bottom-10 left-0 whitespace-nowrap"
                                                                                    onMouseEnter={handlePopupEnter}
                                                                                    onMouseLeave={handlePopupLeave}
                                                                                >
                                                                                    <a
                                                                                        href={`https://handbook.monash.edu/2026/units/${unit.code}`}
                                                                                        target="_blank"
                                                                                        rel="noopener noreferrer"
                                                                                        className="hover:underline"
                                                                                    >
                                                                                        View in Handbook →
                                                                                    </a>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <div className={`h-24 border-2 border-dashed rounded-lg flex items-center justify-center text-gray-400 text-xs w-full cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition ${
                                                                            selectedUnit ? 'border-blue-300 bg-blue-50' : 'border-gray-200'
                                                                        }`}>
                                                                            {selectedUnit ? 'Click to place unit' : 'Drop unit here'}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}    
                                        </tbody>
                                    </table>
                                    
                                    <div className="p-4 bg-gray-50 border-t border-gray-300 flex justify-center">
                                        <button
                                            onClick={addSemester}
                                            className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold"
                                        >
                                            <Plus />
                                            Add Semester
                                        </button>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonashCoursePlanner />);
    </script>
</body>
</html>
