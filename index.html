<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monash Course Planner</title>
    <link rel="icon" type="image/x-icon" href="https://www.monash.edu/favicon.ico">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    
        /* Dark mode styles */
        .dark .bg-gray-50 { background-color: #1f2937 !important; }
        .dark .bg-white { background-color: #111827 !important; }
        .dark .bg-gray-100 { background-color: #374151 !important; }
        .dark .text-gray-800 { color: #f3f4f6 !important; }
        .dark .text-gray-700 { color: #d1d5db !important; }
        .dark .text-gray-600 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #9ca3af !important; }
        .dark .text-gray-400 { color: #6b7280 !important; }
        .dark .border-gray-300 { border-color: #374151 !important; }
        .dark .border-gray-200 { border-color: #374151 !important; }
</style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const UNITS_CSV_URL = 'https://raw.githubusercontent.com/JoelK06/Monash-units/refs/heads/main/monash_units_complete.csv';
        
        const FACULTY_COLORS = {
            "Business & Economics": "#00bcd4",
            "Engineering": "#ff9800",
            "Science": "#009688",
            "Arts": "#e91e63",
            "Medicine, Nursing & Health Sciences": "#2196f3",
            "Information Technology": "#9c27b0",
            "Law": "#795548",
            "Education": "#f06292",
            "Pharmacy & Pharmaceutical Sciences": "#8bc34a",
            "Art, Design & Architecture": "#607d8b",
            "Unknown": "#0069a7"
        };
        
        // Icon components
        const Search = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );
        
        const Plus = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );
        
        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

       const Info = () => (
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="23" x2="12" y2="10" stroke-width="3"></line>
                <circle cx="12" cy="5" r="1"></circle>
            </svg>
        );

        const Bug = () => (
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="m8 2 1.88 1.88"></path>
                <path d="M14.12 3.88 16 2"></path>
                <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"></path>
                <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"></path>
                <path d="M12 20v-9"></path>
                <path d="M6.53 9C4.6 8.8 3 7.1 3 5"></path>
                <path d="M6 13H2"></path>
                <path d="M3 21c0-2.1 1.7-3.9 3.8-4"></path>
                <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"></path>
                <path d="M22 13h-4"></path>
                <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"></path>
            </svg>
        );
        
        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );
        
        const X = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );
        
        const Loader = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2" y1="12" x2="6" y2="12"></line>
                <line x1="18" y1="12" x2="22" y2="12"></line>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
            </svg>
        );
        
        const MonashCoursePlanner = () => {
            const [showLanding, setShowLanding] = useState(true);
            const [showSetup, setShowSetup] = useState(false);
            const [loading, setLoading] = useState(false);
            const [unitsData, setUnitsData] = useState([]);
            const [startYear, setStartYear] = useState(2025);
            const [degreeLength, setDegreeLength] = useState(4);
            const [semesters, setSemesters] = useState([]);
            const [selectedFaculty, setSelectedFaculty] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [draggedUnit, setDraggedUnit] = useState(null);
            const [hoveredUnit, setHoveredUnit] = useState(null);
            const [hoverTimeout, setHoverTimeout] = useState(null);
            const [contextMenuSemester, setContextMenuSemester] = useState(null);
            const [touchStartPos, setTouchStartPos] = useState(null);
            const [plans, setPlans] = useState([]);
            const [currentPlanId, setCurrentPlanId] = useState(null);
            const [selectedUnit, setSelectedUnit] = useState(null);
            const [selectedFromSidebar, setSelectedFromSidebar] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [editingPlanId, setEditingPlanId] = useState(null);
            const [editingPlanName, setEditingPlanName] = useState('');
            const [openPlanMenuId, setOpenPlanMenuId] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);


            useEffect(() => {
                const checkMobile = () => {
                    // Check if device is mobile based on touch support and screen size
                    const mobile = ('ontouchstart' in window || navigator.maxTouchPoints > 0) && window.innerWidth < 1024;
                    setIsMobile(mobile);
                };
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);
           
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (openPlanMenuId && !e.target.closest('.plan-menu-container')) {
                        setOpenPlanMenuId(null);
                    }
                    if (showSettings && !e.target.closest('.settings-container')) {
                        setShowSettings(false);
                    }
                    if (contextMenuSemester && !e.target.closest('.semester-menu-container')) {
                        setContextMenuSemester(null);
                    }
                    if (showInfoModal && !e.target.closest('.info-modal-content')) {
                        setShowInfoModal(false);
                    }
                };

                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [openPlanMenuId, showSettings, contextMenuSemester, showInfoModal]);
            
            useEffect(() => {
                const loadUnits = async () => {
                    const cached = localStorage.getItem('monashUnitsData');
                    const cacheTimestamp = localStorage.getItem('monashUnitsCacheTime');
                    const oneWeek = 7 * 24 * 60 * 60 * 1000;
                    
                    if (cached && cacheTimestamp && (Date.now() - parseInt(cacheTimestamp) < oneWeek)) {
                        setUnitsData(JSON.parse(cached));
                        return;
                    }
                    
                    setLoading(true);
                    try {
                        const response = await fetch(UNITS_CSV_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const text = await response.text();
                        
                        const lines = text.trim().split('\n');
                        
                        const units = lines.slice(1)
                            .filter(line => line.trim())
                            .map(line => {
                                const regex = /(?:,|^)("(?:[^"]|"")*"|[^,]*)/g;
                                const values = [];
                                let match;
                                while ((match = regex.exec(line)) !== null) {
                                    if (match[1]) {
                                        values.push(match[1].replace(/^"|"$/g, '').replace(/""/g, '"').trim());
                                    }
                                }
                                
                                return {
                                    code: values[0] || '',
                                    name: values[1] || '',
                                    level: values[2] || '',
                                    semesters: values[3] || '',
                                    faculty: values[4] || ''
                                };
                            })
                            .filter(unit => unit.code && unit.code !== 'code');
                        
                        setUnitsData(units);
                        localStorage.setItem('monashUnitsData', JSON.stringify(units));
                        localStorage.setItem('monashUnitsCacheTime', Date.now().toString());
                    } catch (error) {
                        console.error('Error loading units:', error);
                        alert('Failed to load units data: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadUnits();
            }, []);
            
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('monashCoursePlans');
                    if (saved) {
                        const allPlans = JSON.parse(saved);
                        setPlans(allPlans);
                        if (allPlans.length > 0) {
                            const lastPlanId = localStorage.getItem('monashLastPlanId');
                            const planToLoad = allPlans.find(p => p.id === lastPlanId) || allPlans[0];
                            setCurrentPlanId(planToLoad.id);
                            loadPlan(planToLoad);
                            setShowLanding(false);
                        }
                    }
                } catch (error) {
                    console.error('Error loading saved plans:', error);
                    localStorage.removeItem('monashCoursePlans');
                }
            }, []);
            
            useEffect(() => {
                const savedDarkMode = localStorage.getItem('monashDarkMode');
                if (savedDarkMode === 'true') {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
            }, []);

            const toggleDarkMode = () => {
                const newDarkMode = !darkMode;
                setDarkMode(newDarkMode);
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('monashDarkMode', newDarkMode.toString());
            };


            const loadPlan = (plan) => {
                const validSemesters = plan.semesters.map(sem => ({
                    ...sem,
                    units: Array.isArray(sem.units) ? sem.units : [null, null, null, null]
                }));
                setStartYear(plan.startYear);
                setDegreeLength(plan.degreeLength);
                setSemesters(validSemesters);
            };
            
            const savePlans = (updatedPlans, planId) => {
                setPlans(updatedPlans);
                localStorage.setItem('monashCoursePlans', JSON.stringify(updatedPlans));
                localStorage.setItem('monashLastPlanId', planId);
            };
            
            
            const updateCurrentPlan = (newSemesters, newStartYear, newDegreeLength) => {
                const updatedPlans = plans.map(p => 
                    p.id === currentPlanId 
                        ? { ...p, semesters: newSemesters, startYear: newStartYear || startYear, degreeLength: newDegreeLength || degreeLength }
                        : p
                );
                savePlans(updatedPlans, currentPlanId);
            };
            
            useEffect(() => {
                if (semesters.length > 0 && currentPlanId) {
                    updateCurrentPlan(semesters);
                }
            }, [semesters]);
            
            const renamePlan = (planId, newName) => {
                if (!newName.trim()) return;
                
                const updatedPlans = plans.map(p => 
                    p.id === planId ? { ...p, name: newName.trim() } : p
                );
                savePlans(updatedPlans, currentPlanId);
            };

            const handlePlanDoubleClick = (plan) => {
                setEditingPlanId(plan.id);
                setEditingPlanName(plan.name);
            };

            const handleRenameKeyDown = (e, planId) => {
                if (e.key === 'Enter') {
                    renamePlan(planId, editingPlanName);
                    setEditingPlanId(null);
                } else if (e.key === 'Escape') {
                    setEditingPlanId(null);
                }
            };

            const handleRenameBlur = (planId) => {
                renamePlan(planId, editingPlanName);
                setEditingPlanId(null);
            };

            const handleStartNew = () => {
                setShowLanding(false);
                setShowSetup(true);
            };
            
            const createNewPlan = () => {
                const newPlan = {
                    id: 'plan-' + Date.now(),
                    name: `Plan ${plans.length + 1}`,
                    startYear: 2025,
                    degreeLength: 4,
                    semesters: []
                };
                const newSemesters = [];
                for (let year = 0; year < 4; year++) {
                    newSemesters.push({
                        id: `s1-${year}`,
                        label: `Semester 1, ${2025 + year}`,
                        semesterType: 'Semester 1',
                        units: [null, null, null, null]
                    });
                    newSemesters.push({
                        id: `s2-${year}`,
                        label: `Semester 2, ${2025 + year}`,
                        semesterType: 'Semester 2',
                        units: [null, null, null, null]
                    });
                }
                newPlan.semesters = newSemesters;
                const updatedPlans = [...plans, newPlan];
                savePlans(updatedPlans, newPlan.id);
                setCurrentPlanId(newPlan.id);
                loadPlan(newPlan);
            };
            
            const switchPlan = (planId) => {
                const plan = plans.find(p => p.id === planId);
                if (plan) {
                    setCurrentPlanId(planId);
                    loadPlan(plan);
                    localStorage.setItem('monashLastPlanId', planId);
                }
            };
            
            const deletePlan = () => {
                // ADDED: Confirmation dialog before deletion
                const currentPlan = plans.find(p => p.id === currentPlanId);
                const planName = currentPlan?.name || 'this plan';
                
                if (!confirm(`Are you sure you want to delete "${planName}"? This action cannot be undone.`)) {
                    return;
                }
                
                if (plans.length === 1) {
                    // Last plan - clear everything
                    setPlans([]);
                    setSemesters([]);
                    setCurrentPlanId(null);
                    setShowLanding(true);
                    localStorage.removeItem('monashCoursePlans');
                    localStorage.removeItem('monashLastPlanId');
                } else {
                    const updatedPlans = plans.filter(p => p.id !== currentPlanId);
                    const newCurrentPlan = updatedPlans[0];
                    savePlans(updatedPlans, newCurrentPlan.id);
                    setCurrentPlanId(newCurrentPlan.id);
                    loadPlan(newCurrentPlan);
                }
            };
            
            const clearCurrentPlan = () => {
                if (confirm('Clear all units from this plan? This cannot be undone.')) {
                    const clearedSemesters = semesters.map(sem => ({
                        ...sem,
                        units: [null, null, null, null]
                    }));
                    setSemesters(clearedSemesters);
                }
            };
            
            const handleLoadCourse = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            // Create a new plan with the loaded data
                            const fileName = file.name.replace('.json', '').replace(/[-_]/g, ' ');
                            const planName = data.name || fileName || `Loaded Plan`;
                            
                            const newPlan = {
                                id: 'plan-' + Date.now(),
                                name: planName,
                                startYear: data.startYear || 2025,
                                degreeLength: data.degreeLength || 4,
                                semesters: data.semesters || []
                            };
                            
                            // Ensure semesters have the right structure
                            const validSemesters = newPlan.semesters.map(sem => ({
                                ...sem,
                                units: Array.isArray(sem.units) ? sem.units : [null, null, null, null],
                                isAcademicLeave: sem.isAcademicLeave || false
                            }));
                            newPlan.semesters = validSemesters;
                            
                            const updatedPlans = [...plans, newPlan];
                            savePlans(updatedPlans, newPlan.id);
                            setCurrentPlanId(newPlan.id);
                            setStartYear(newPlan.startYear);
                            setDegreeLength(newPlan.degreeLength);
                            setSemesters(validSemesters);
                            setShowLanding(false);
                            
                        } catch (error) {
                            console.error('Error loading plan:', error);
                            alert('Failed to load plan. Please make sure it\'s a valid course plan file.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            const handleImportCourse = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            // Create a new plan with the imported data
                            const fileName = file.name.replace('.json', '').replace(/[-_]/g, ' ');
                            const planName = data.name || fileName || `Imported Plan`;
                            
                            const newPlan = {
                                id: 'plan-' + Date.now(),
                                name: planName,
                                startYear: data.startYear || 2025,
                                degreeLength: data.degreeLength || 4,
                                semesters: data.semesters || []
                            };
                            
                            // Ensure semesters have the right structure
                            const validSemesters = newPlan.semesters.map(sem => ({
                                ...sem,
                                units: Array.isArray(sem.units) ? sem.units : [null, null, null, null],
                                isAcademicLeave: sem.isAcademicLeave || false
                            }));
                            newPlan.semesters = validSemesters;
                            
                            const updatedPlans = [...plans, newPlan];
                            savePlans(updatedPlans, newPlan.id);
                            setCurrentPlanId(newPlan.id);
                            setStartYear(newPlan.startYear);
                            setDegreeLength(newPlan.degreeLength);
                            setSemesters(validSemesters);
                            
                        } catch (error) {
                            console.error('Error importing plan:', error);
                            alert('Failed to import plan. Please make sure it\'s a valid course plan file.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            const resetSemester = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units = [null, null, null, null];
                newSemesters[semIndex].isAcademicLeave = false;
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };
            
            const setAcademicLeave = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units = ['ACADEMIC_LEAVE'];
                newSemesters[semIndex].isAcademicLeave = true;
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };
            
            const removeAcademicLeave = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units = [null, null, null, null];
                newSemesters[semIndex].isAcademicLeave = false;
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };

            const addOverloadUnit = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units.push(null);
                setSemesters(newSemesters);
                setContextMenuSemester(null);
            };
            
            const removeOverloadUnit = (semesterId) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                if (newSemesters[semIndex].units.length > 4) {
                    newSemesters[semIndex].units.pop();
                    setSemesters(newSemesters);
                }
                setContextMenuSemester(null);
            };
            
            const deleteSemester = (semesterId) => {
                const semIndex = semesters.findIndex(s => s.id === semesterId);
                if (semIndex === semesters.length - 1 && semesters.length > 1) {
                    setSemesters(semesters.slice(0, -1));
                }
                setContextMenuSemester(null);
            };
                     
            const handleSetupComplete = () => {
                const newSemesters = [];
                for (let year = 0; year < degreeLength; year++) {
                    newSemesters.push({
                        id: `s1-${year}`,
                        label: `Semester 1, ${startYear + year}`,
                        semesterType: 'Semester 1',
                        units: [null, null, null, null]
                    });
                    newSemesters.push({
                        id: `s2-${year}`,
                        label: `Semester 2, ${startYear + year}`,
                        semesterType: 'Semester 2',
                        units: [null, null, null, null]
                    });
                }
                
                const newPlan = {
                    id: 'plan-' + Date.now(),
                    name: `Plan ${plans.length + 1}`,
                    startYear,
                    degreeLength,
                    semesters: newSemesters
                };
                
                const updatedPlans = [...plans, newPlan];
                savePlans(updatedPlans, newPlan.id);
                setCurrentPlanId(newPlan.id);
                setSemesters(newSemesters);
                setShowSetup(false);
            };
            
            const addSemester = () => {
                const lastSem = semesters[semesters.length - 1];
                const lastYear = parseInt(lastSem.label.split(', ')[1]);
                const isS1 = lastSem.semesterType === 'Semester 1';
                const newYear = isS1 ? lastYear : lastYear + 1;
                const newSemType = isS1 ? 'Semester 2' : 'Semester 1';
                
                setSemesters([...semesters, {
                    id: `${newSemType.toLowerCase().replace(' ', '')}-${Date.now()}`,
                    label: `${newSemType}, ${newYear}`,
                    semesterType: newSemType,
                    units: [null, null, null, null]
                }]);
            };
            
            const removeSemester = () => {
                if (semesters.length > 1) {
                    setSemesters(semesters.slice(0, -1));
                }
            };
            
            const handleDragStart = (unit) => {
                setDraggedUnit(unit);
                setSelectedUnit(null);
                setSelectedFromSidebar(false);
            };
            
            const handleUnitClick = (unit, isFromSidebar = false) => {
                if (selectedUnit && selectedUnit.code === unit.code) {
                    setSelectedUnit(null);
                    setSelectedFromSidebar(false);
                } else {
                    setSelectedUnit(unit);
                    setSelectedFromSidebar(isFromSidebar);
                }
            };
            
            const handleSlotClick = (semesterId, unitIndex) => {
                if (selectedUnit) {
                    handleDrop(semesterId, unitIndex);
                    setSelectedUnit(null);
                }
            };
            
            const handleTouchStart = (e, unit) => {
                const touch = e.touches[0];
                setTouchStartPos({ x: touch.clientX, y: touch.clientY });
                setDraggedUnit(unit);
            };
            
            const handleTouchMove = (e) => {
                if (!draggedUnit) return;
                e.preventDefault();
            };
            
            const handleTouchEnd = (e, semesterId, unitIndex) => {
                if (!draggedUnit) return;
                handleDrop(semesterId, unitIndex);
                setTouchStartPos(null);
            };
            
            const handleDrop = (semesterId, unitIndex) => {
                const unitToPlace = draggedUnit || selectedUnit;
                if (!unitToPlace) return;
                
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                
                // Check if we're moving from the grid (not from sidebar)
                let fromSemIndex = -1;
                let fromUnitIndex = -1;
                
                // Check if unit has an instance ID (meaning it's from the grid)
                const isFromGrid = unitToPlace._instanceId !== undefined;
                
                if (isFromGrid) {
                    // Look for source using unique instance ID
                    for (let i = 0; i < newSemesters.length; i++) {
                        const foundIndex = newSemesters[i].units.findIndex(u => 
                            u && u._instanceId === unitToPlace._instanceId
                        );
                        if (foundIndex !== -1) {
                            fromSemIndex = i;
                            fromUnitIndex = foundIndex;
                            break;
                        }
                    }
                    
                    // If moving to the same spot, do nothing
                    if (fromSemIndex === semIndex && fromUnitIndex === unitIndex) {
                        setDraggedUnit(null);
                        setSelectedUnit(null);
                        setSelectedFromSidebar(false);
                        return;
                    }
                    
                    // Moving from grid - swap positions
                    const temp = newSemesters[semIndex].units[unitIndex];
                    newSemesters[semIndex].units[unitIndex] = unitToPlace;
                    newSemesters[fromSemIndex].units[fromUnitIndex] = temp;
                } else {
                    // Adding from sidebar - check if duplicate exists in this semester
                    const duplicateIndex = newSemesters[semIndex].units.findIndex(
                        (u, idx) => u && u.code === unitToPlace.code && idx !== unitIndex
                    );
                    
                    if (duplicateIndex !== -1) {
                        // Replace the existing duplicate instead of creating another
                        newSemesters[semIndex].units[duplicateIndex] = null;
                    }
                    
                    // Create a new instance with unique ID
                    const newUnit = { ...unitToPlace, _instanceId: Date.now() + Math.random() };
                    newSemesters[semIndex].units[unitIndex] = newUnit;
                }
                
                setSemesters(newSemesters);
                setDraggedUnit(null);
                setSelectedUnit(null);
                setSelectedFromSidebar(false);
            };
            
            const removeUnit = (semesterId, unitIndex) => {
                const newSemesters = [...semesters];
                const semIndex = newSemesters.findIndex(s => s.id === semesterId);
                newSemesters[semIndex].units[unitIndex] = null;
                setSemesters(newSemesters);
            };
            
            const exportPlan = () => {
                const currentPlan = plans.find(p => p.id === currentPlanId);
                const dataStr = JSON.stringify({ 
                    startYear, 
                    degreeLength, 
                    semesters,
                    name: currentPlan?.name || 'Course Plan'
                }, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `monash-${currentPlan?.name.toLowerCase().replace(/\s+/g, '-')}-${startYear}.json`;
                link.click();
            };
            
            const faculties = [...new Set(unitsData.map(u => u.faculty))].filter(Boolean).sort();
            const filteredUnits = searchQuery
                ? unitsData.filter(u =>
                    u.code.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    u.name.toLowerCase().includes(searchQuery.toLowerCase())
                  )
                : selectedFaculty
                ? unitsData.filter(u => u.faculty === selectedFaculty)
                : [];
            
            const hasDuplicateInSemester = (semester, unitCode) => {
                return semester.units.filter(u => u && u.code === unitCode).length > 1;
            };
            
            const isUnitOffered = (unit, semesterType) => {
                if (!unit) return true;
                if (!unit.semesters || unit.semesters.includes('Not offered')) return true;
                return unit.semesters.includes(semesterType);
            };
            
            const handleMouseEnter = (unit) => {
                const timeout = setTimeout(() => {
                    setHoveredUnit(unit);
                }, 800);
                setHoverTimeout(timeout);
            };
            
            const handleMouseLeave = () => {
                if (hoverTimeout) clearTimeout(hoverTimeout);
                const timeout = setTimeout(() => {
                    setHoveredUnit(null);
                }, 300);
                setHoverTimeout(timeout);
            };
            
            const handlePopupEnter = () => {
                if (hoverTimeout) clearTimeout(hoverTimeout);
            };
            
            const handlePopupLeave = () => {
                setHoveredUnit(null);
            };
            
            const InfoModal = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto info-modal-content">
                        <div className="p-6">
                            <div className="flex justify-between items-start mb-4">
                                <h2 className="text-2xl font-bold text-gray-800">About Monash Course Planner</h2>
                                <button
                                    onClick={() => setShowInfoModal(false)}
                                    className="text-gray-500 hover:text-gray-700 text-2xl"
                                >
                                    ×
                                </button>
                            </div>
                            <div className="text-gray-700 space-y-4">
                                <p>This project was born due to the official Mon Planner being outdated and not including new units (The combination of Mech Aero and Mechatronic engineering units). It was first developed as an excel spreadsheet using lookup tables then later developed into this git hub page where it is free for anyone to use.</p>
                                <p>The hope is that it may help make someone's course planning just a little easier. Note that as this was a quick project it does not consider credit points, prohibitions, prerequisites, and other such details. The one thing it does do is consider what units run in which semesters, which is helpful for degrees where many units only run once a year.</p>
                                <p>Thank you for using my program!</p>
                                <p className="font-semibold">Created by Joel Knight</p>
                            </div>
                            <div className="mt-6 pt-6 border-t border-gray-200">
                                <button
                                    onClick={() => {
                                        window.open('https://github.com/JoelK06/Monash-Course-Planner/issues', '_blank');
                                        setShowInfoModal(false);
                                    }}
                                    className="flex items-center gap-2 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition w-full justify-center"
                                >
                                    <Bug />
                                    Report Bugs on GitHub
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="bg-white shadow-2xl p-12 text-center">
                            <div className="mx-auto mb-4"><Loader /></div>
                            <h2 className="text-2xl font-bold text-gray-800">Loading Monash Units...</h2>
                            <p className="text-gray-600 mt-2">Fetching 5000+ units from database</p>
                        </div>
                    </div>
                );
            }
            
            if (showLanding) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-8">
                        <div className="bg-white shadow-2xl p-12 max-w-2xl">
                            <h1 className="text-4xl font-bold text-gray-800 mb-6">Monash Course Planner</h1>
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-6 mb-8">
                                <h2 className="font-bold text-lg mb-3">Instructions:</h2>
                                <ul className="space-y-2 text-gray-700">
                                    <li>• Contains 5000+ units from the Monash handbook</li>
                                    <li>• Drag units from the sidebar into your semester grid</li>
                                    <li>• Click the menu button on semesters for more options</li>
                                    <li>• Create multiple plans and switch between them</li>
                                    <li>• Your plans auto-save in your browser</li>
                                    <li>• Always check the handbook before making final decisions</li>
                                </ul>
                            </div>
                            <div className="flex gap-4">
                                <button
                                    onClick={handleStartNew}
                                    className="flex-1 bg-blue-600 text-white py-4 px-6 font-semibold hover:bg-blue-700 transition"
                                >
                                    Start New Plan
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (showSetup) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-8">
                        <div className="bg-white shadow-2xl p-12 max-w-md">
                            <h2 className="text-3xl font-bold text-gray-800 mb-8">Setup Your Plan</h2>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Start Year
                                    </label>
                                    <input
                                        type="number"
                                        value={startYear}
                                        onChange={(e) => setStartYear(parseInt(e.target.value))}
                                        className="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Degree Length (years)
                                    </label>
                                    <input
                                        type="number"
                                        value={degreeLength}
                                        onChange={(e) => setDegreeLength(parseInt(e.target.value))}
                                        min="1"
                                        max="12"
                                        className="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <button
                                    onClick={handleSetupComplete}
                                    className="w-full bg-blue-600 text-white py-4 font-semibold hover:bg-blue-700 transition"
                                >
                                    Create Plan
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className={`flex h-screen ${darkMode ? 'dark' : ''}`}>
                    <div className="w-80 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                        <div className="p-4 border-b border-gray-200">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Unit Library</h2>
                            <div className="relative settings-container">
                                <div className="absolute left-3 top-3 text-gray-400"><Search /></div>
                                <input
                                    type="text"
                                    placeholder="Search units..."
                                    value={searchQuery}
                                    onChange={(e) => {
                                        setSearchQuery(e.target.value);
                                        setSelectedFaculty(null);
                                    }}
                                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4">
                            {!searchQuery && !selectedFaculty && (
                                <div className="space-y-2">
                                    {faculties.map(faculty => (
                                        <button
                                            key={faculty}
                                            onClick={() => setSelectedFaculty(faculty)}
                                            className="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 font-medium text-gray-700 transition"
                                        >
                                            {faculty}
                                        </button>
                                    ))}
                                </div>
                            )}
                            
                            {(searchQuery || selectedFaculty) && (
                                <div>
                                    {selectedFaculty && (
                                        <button
                                            onClick={() => setSelectedFaculty(null)}
                                            className="mb-4 text-sm text-blue-600 hover:text-blue-800"
                                        >
                                            ← Back to faculties
                                        </button>
                                    )}
                                    <div className="space-y-2">
                                        {filteredUnits.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8">
                                                No units found
                                            </div>
                                        ) : (
                                            filteredUnits.map(unit => (
                                                <div
                                                    key={unit.code}
                                                    draggable
                                                    onDragStart={() => handleDragStart(unit)}
                                                    onTouchStart={(e) => handleTouchStart(e, unit)}
                                                    onTouchMove={handleTouchMove}
                                                    onClick={() => handleUnitClick(unit, true)}
                                                    className={`bg-white border rounded-lg p-3 cursor-pointer hover:shadow-md transition flex touch-none ${
                                                        selectedUnit && selectedUnit.code === unit.code
                                                            ? 'border-blue-500 border-2 shadow-lg'
                                                            : 'border-gray-200'
                                                    }`}
                                                >
                                                    <div
                                                        className="w-1 rounded-l-lg mr-3"
                                                        style={{ backgroundColor: FACULTY_COLORS[unit.faculty] || FACULTY_COLORS["Unknown"] }}
                                                    />
                                                    <div className="flex-1">
                                                        <div className="font-bold text-gray-800">{unit.code}</div>
                                                        <div className="text-sm text-gray-600">{unit.name}</div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900">
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 relative z-10">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <h1 className="text-2xl font-bold text-white">Monash Course Planner</h1>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setShowInfoModal(true);
                                        }}
                                        className="text-white hover:text-blue-100 transition border border-white/50 rounded-full p-1 hover:bg-white/10"
                                        title="About this project"
                                    >
                                        <Info />
                                    </button>
                                </div>
                                <div className="flex items-center gap-4">
                                    <button
                                        onClick={() => window.open('https://github.com/JoelK06/Monash-Course-Planner/issues', '_blank')}
                                        className="flex items-center gap-2 border border-white/50 text-white px-3 py-1 rounded-lg hover:bg-white/10 transition text-sm"
                                    >
                                        <Bug />
                                        Report Bugs
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-white border-b border-gray-200 p-4 flex justify-between items-center flex-shrink-0">
                            <div className="flex items-center gap-2 plan-menu-container">
                                {plans.map(plan => (
                                    <div key={plan.id} className="relative">
                                        {editingPlanId === plan.id ? (
                                            <input
                                                type="text"
                                                value={editingPlanName}
                                                onChange={(e) => setEditingPlanName(e.target.value)}
                                                onKeyDown={(e) => handleRenameKeyDown(e, plan.id)}
                                                onBlur={() => handleRenameBlur(plan.id)}
                                                className="px-4 py-2 rounded-lg border border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-32"
                                                autoFocus
                                            />
                                        ) : (
                                            <div className="flex items-center">
                                                <button
                                                    onClick={() => switchPlan(plan.id)}
                                                    onDoubleClick={() => handlePlanDoubleClick(plan)}
                                                    className={`px-4 py-2 rounded-l-lg font-medium transition ${
                                                        plan.id === currentPlanId
                                                            ? 'bg-blue-600 text-white'
                                                            : 'border border-blue-600 text-blue-600 bg-white hover:bg-blue-50'
                                                    }`}
                                                    title="Double-click to rename"
                                                >
                                                    {plan.name}
                                                </button>
                                                <button
                                                    onClick={() => setOpenPlanMenuId(openPlanMenuId === plan.id ? null : plan.id)}
                                                    className={`px-2 py-3 rounded-r-lg border-l border-blue-600 font-medium transition ${
                                                        plan.id === currentPlanId
                                                            ? 'bg-blue-700 text-white'
                                                            : 'border border-blue-600 text-blue-600 bg-white hover:bg-blue-50'
                                                    }`}
                                                >
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                        <circle cx="12" cy="5" r="2"></circle>
                                                        <circle cx="12" cy="12" r="2"></circle>
                                                        <circle cx="12" cy="19" r="2"></circle>
                                                    </svg>
                                                </button>
                    
                                                {openPlanMenuId === plan.id && (
                                                    <div className="absolute top-full mt-1 left-0 bg-white border border-gray-300 rounded-lg shadow-lg z-50 w-48">
                                                        <button
                                                            onClick={() => {
                                                                if (plan.id === currentPlanId) {
                                                                    clearCurrentPlan();
                                                                } else {
                                                                    switchPlan(plan.id);
                                                                    setTimeout(() => clearCurrentPlan(), 100);
                                                                }
                                                                setOpenPlanMenuId(null);
                                                            }}
                                                           className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200"
                                                        >
                                                            Clear Plan
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                if (plan.id === currentPlanId) {
                                                                    deletePlan();
                                                                } else {
                                                                    const planToDelete = plans.find(p => p.id === plan.id);
                                                                    if (confirm(`Delete "${planToDelete?.name}"?`)) {
                                                                        const updatedPlans = plans.filter(p => p.id !== plan.id);
                                                                        savePlans(updatedPlans, currentPlanId === plan.id ? updatedPlans[0]?.id : currentPlanId);
                                                                        setPlans(updatedPlans);
                                                                        if (currentPlanId === plan.id && updatedPlans.length > 0) {
                                                                            loadPlan(updatedPlans[0]);
                                                                        } else if (updatedPlans.length === 0) {
                                                                            setShowLanding(true);
                                                                        }
                                                                    }
                                                                }
                                                                setOpenPlanMenuId(null);
                                                            }}
                                                            className="w-full text-left px-4 py-2 hover:bg-red-100 text-red-600 text-sm border-t border-gray-200"
                                                        >
                                                            Delete Plan
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
    
                                <button
                                    onClick={createNewPlan}
                                    className="px-4 py-2 rounded-lg border border-blue-600 text-blue-600 bg-white hover:bg-blue-50 transition font-medium"
                                >
                                    +
                                </button>
                            </div>
                            <div className="flex gap-2">
                                <div className="relative settings-container">
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setShowSettings(!showSettings);
                                        }}
                                        className="flex items-center gap-2 border border-blue-600 text-blue-600 bg-white px-4 py-2 rounded-lg hover:bg-blue-50 transition"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                        </svg>
                                        Settings
                                    </button>
        
                                    {showSettings && (
                                        <div className="absolute right-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 rounded-lg shadow-lg z-50 w-48">
                                            <button
                                                onClick={handleImportCourse}
                                                className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2"
                                            >
                                                <Upload />
                                                Import Plan
                                            </button>
                                            <button
                                                onClick={exportPlan}
                                                className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2"
                                            >
                                                <Download />
                                                Export Plan
                                            </button>
                                            <button
                                                onClick={toggleDarkMode}
                                                className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2"
                                            >
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    {darkMode ? (
                                                        <circle cx="12" cy="12" r="5"></circle>
                                                    ) : (
                                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                                    )}
                                                </svg>
                                                {darkMode ? 'Light Mode' : 'Dark Mode'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>    
			</div>

                        <div className="flex-1 overflow-auto p-8 relative">
                            <div className="bg-white shadow-lg overflow-hidden">
                                <table className="w-full border-collapse" style={{ minWidth: '900px' }}>
                                        <thead>
                                            <tr className="bg-gray-100 dark:bg-gray-700">
                                                <th className="border border-gray-300 p-3 text-left font-semibold text-gray-800 dark:text-gray-200" style={{width: '180px'}}>Semester</th>
                                                <th className="border border-gray-300 p-3 text-center font-semibold text-gray-800 dark:text-gray-200">Units</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {semesters.map((semester, semIdx) => (
                                                <tr key={semester.id}>
                                                    <td
                                                        className="border border-gray-300 p-3 font-medium bg-gray-50 relative align-top semester-menu-container"
                                                        style={{width: '180px'}}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-gray-800 dark:text-gray-200">{semester.label}</span>
                                                            <button
                                                                onClick={() => setContextMenuSemester(contextMenuSemester === semester.id ? null : semester.id)}
                                                                className="text-gray-500 hover:text-gray-700 p-1"
                                                            >
                                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                                    <circle cx="12" cy="5" r="2"></circle>
                                                                    <circle cx="12" cy="12" r="2"></circle>
                                                                    <circle cx="12" cy="19" r="2"></circle>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        {contextMenuSemester === semester.id && (
                                                            <div className="absolute left-full ml-2 top-0 bg-white dark:bg-gray-800 border border-gray-300 rounded-lg shadow-lg z-50 w-56">
                                                                <button
                                                                    onClick={() => resetSemester(semester.id)}
                                                                    className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200"
                                                                >
                                                                    Reset Semester (4 units)
                                                                </button>
                                                                {!semester.isAcademicLeave && (
                                                                    <>
                                                                        <button
                                                                            onClick={() => addOverloadUnit(semester.id)}
                                                                            className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200"
                                                                        >
                                                                            Add Overload Unit
                                                                        </button>
                                                                        {semester.units.length > 4 && (
                                                                            <button
                                                                                onClick={() => removeOverloadUnit(semester.id)}
                                                                                className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200"
                                                                            >
                                                                                Remove Overload Unit
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={() => setAcademicLeave(semester.id)}
                                                                            className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2"
                                                                        >
                                                                            Set as Academic Leave
                                                                        </button>
                                                                    </>
                                                                )}
                                                                {semester.isAcademicLeave && (
                                                                    <button
                                                                        onClick={() => removeAcademicLeave(semester.id)}
                                                                        className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2"
                                                                    >
                                                                        Remove Academic Leave
                                                                    </button>
                                                                )}
                                                                {semIdx === semesters.length - 1 && (
                                                                    <button
                                                                        onClick={() => deleteSemester(semester.id)}
                                                                        className="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2"
                                                                    >
                                                                        Delete Semester
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="border border-gray-300 p-2 align-top">
                                                        {semester.isAcademicLeave ? (
                                                            <div className="h-24 bg-white dark:bg-gray-800 border-2 border-yellow-500 rounded-lg flex items-center justify-center">
                                                                <span className="text-yellow-600 dark:text-yellow-400 font-semibold">Academic Leave</span>
                                                            </div>
                                                        ) : (
                                                            <div className={isMobile ? 'grid gap-2 grid-cols-2' : 'grid gap-2 grid-cols-' + semester.units.length}>
                                                                {semester.units.map((unit, unitIdx) => (
                                                                <div
                                                                    key={unit?._instanceId || `empty-${unitIdx}`}
                                                                    className="flex"
                                                                    onDragOver={(e) => e.preventDefault()}
                                                                    onDrop={() => handleDrop(semester.id, unitIdx)}
                                                                    onTouchEnd={(e) => handleTouchEnd(e, semester.id, unitIdx)}
                                                                    onClick={() => handleSlotClick(semester.id, unitIdx)}
                                                                >
                                                                    {unit ? (
                                                                        <div
                                                                            className="relative bg-white border border-gray-200 rounded-lg p-3 h-24 flex group w-full cursor-pointer"
                                                                            draggable
                                                                            onDragStart={() => handleDragStart(unit)}
                                                                            onTouchStart={(e) => handleTouchStart(e, unit)}
                                                                            onMouseEnter={() => handleMouseEnter(unit)}
                                                                            onMouseLeave={handleMouseLeave}
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleUnitClick(unit, false);
                                                                            }}
                                                                        >
                                                                            <div
                                                                                className="w-1 rounded-l-lg mr-3 flex-shrink-0"
                                                                                style={{ backgroundColor: FACULTY_COLORS[unit.faculty] || FACULTY_COLORS["Unknown"] }}
                                                                            />
                                                                            <div className="flex-1 min-w-0 overflow-hidden">
                                                                                <div className="font-bold text-gray-800 text-sm">{unit.code}</div>
                                                                                <div className="text-xs text-gray-600 line-clamp-2">{unit.name}</div>
                                                                                {!isUnitOffered(unit, semester.semesterType) && (
                                                                                    <div className="text-xs text-red-600 mt-1">
                                                                                        ⚠️ Not offered {semester.semesterType}
                                                                                    </div>
                                                                                )}
                                                                                {hasDuplicateInSemester(semester, unit.code) && (
                                                                                    <div className="text-xs text-orange-600 mt-1">
                                                                                        ⚠️ Duplicate in semester
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                            <button
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    removeUnit(semester.id, unitIdx);
                                                                                }}
                                                                                className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition flex-shrink-0 text-gray-800 dark:text-gray-200"
                                                                            >
                                                                                <X />
                                                                            </button>
                                                                            
                                                                            {hoveredUnit && hoveredUnit.code === unit.code && (
                                                                                <div
                                                                                    className="absolute z-50 bg-gray-800 text-white p-2 rounded shadow-lg text-xs top-full mt-1 left-0 whitespace-nowrap"
                                                                                    onMouseEnter={handlePopupEnter}
                                                                                    onMouseLeave={handlePopupLeave}
                                                                                >
                                                                                    <a
                                                                                        href={`https://handbook.monash.edu/2026/units/${unit.code}`}
                                                                                        target="_blank"
                                                                                        rel="noopener noreferrer"
                                                                                        className="hover:underline"
                                                                                    >
                                                                                        View in Handbook →
                                                                                    </a>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <div className={`h-24 border-2 border-dashed rounded-lg flex items-center justify-center text-gray-400 text-xs w-full cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition ${
                                                                            selectedUnit ? 'border-blue-500' : 'border-gray-200'
                                                                        }`}>
                                                                            {selectedUnit ? 'Click to place unit' : 'Drop unit here'}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}    
                                        </tbody>
                                    </table>
                                    
                                    <div className="p-4 bg-gray-50 border-t border-gray-300 flex justify-center">
                                        <button
                                            onClick={addSemester}
                                            className="flex items-center gap-2 border border-gray-300 text-gray-700 bg-white px-6 py-3 rounded-lg hover:bg-gray-50 transition font-medium"
                                        >
                                            <Plus />
                                            Add Semester
                                        </button>
                                    </div>
				</div>
                            </div>
                        </div>
                        {showInfoModal && <InfoModal />}
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonashCoursePlanner />);
    </script>
</body>
</html>
